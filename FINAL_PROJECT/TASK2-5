/*************************************************************

  This is a simple demo of sending and receiving some data.
  Be sure to check out other examples!
 *************************************************************/

/* Fill-in information from Blynk Device Info here */
#define BLYNK_TEMPLATE_ID "*************"
#define BLYNK_TEMPLATE_NAME "Quickstart Template"
#define BLYNK_AUTH_TOKEN "*********************************"

/* Comment this out to disable prints and save space */
#define BLYNK_PRINT Serial

#include <WiFi.h>
#include <WiFiClient.h>
#include <BlynkSimpleEsp32.h>
#include <M5Stack.h>
#include "DHT.h"

int ledPin = 3;
int ledState = LOW;

#define DHTPIN 21
#define DHTTYPE DHT22

DHT dht(DHTPIN, DHTTYPE);

// Your WiFi credentials.
// Set password to "" for open networks.
char ssid[] = "***";
char pass[] = "**********";

BlynkTimer timer;

// This function is called every time the Virtual Pin 0 state changes
BLYNK_WRITE(V0)
{
    // Set incoming value from pin V0 to a variable
    int value = param.asInt();
    event_LED(value);
}

void event_LED(int value)
{
    if (value == 0) {
        ledState = LOW;
        digitalWrite(ledPin, ledState);
    }
    if (value == 1) {
        ledState = HIGH;
        digitalWrite(ledPin, ledState);
    }
}

void event_Btn()
{
    if (M5.BtnA.wasPressed()) Blynk.virtualWrite(V4, 1);
    if (M5.BtnB.wasPressed()) Blynk.virtualWrite(V4, 2);
    if (M5.BtnC.wasPressed()) Blynk.virtualWrite(V4, 3);
}

void event_DHT()
{
    float h = dht.readHumidity();
    float c = dht.readTemperature();
    float f = dht.readTemperature(true);
    if (isnan(h) || isnan(c) || isnan(f)) Serial.println(F("Failed to read from DHT sensor!"));

    Blynk.virtualWrite(V1, h);
    Blynk.virtualWrite(V2, c);
    Blynk.virtualWrite(V3, f);
}

void setup()
{
    // Debug console
    Serial.begin(115200);

    Blynk.begin(BLYNK_AUTH_TOKEN, ssid, pass);
    timer.setInterval(1000L, event_DHT);

    pinMode(ledPin, OUTPUT);
    digitalWrite(ledPin, ledState);

    Serial.println(F("DHTxx test!"));
    dht.begin();
    M5.update();
}

void loop()
{
    Blynk.run();
    timer.run();
    event_Btn();
    M5.update();
    // You can inject your own code or combine it with other sketches.
    // Check other examples on how to communicate with Blynk. Remember
    // to avoid delay() function!
}